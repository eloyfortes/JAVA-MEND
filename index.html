<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Capgemini • Mend POM Assistant</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #f6f7fb, #e9ecf3);
      color: #1f2937;
    }

    header {
      background: #0b5ed7;
      color: white;
      padding: 20px 30px;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    header span {
      font-weight: 300;
      opacity: 0.9;
    }

    main {
      padding: 25px;
      max-width: 1600px;
      margin: auto;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .box {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
    }

    .box h3 {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
      color: #374151;
    }

    textarea {
      flex: 1;
      resize: vertical;
      min-height: 260px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 10px;
      font-family: Consolas, monospace;
      font-size: 13px;
      background: #fafafa;
    }

    textarea:focus {
      outline: none;
      border-color: #0b5ed7;
      background: #fff;
    }

    .actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 20px 0;
      flex-wrap: wrap;
      gap: 10px;
    }

    .actions label {
      font-size: 14px;
    }

    button {
      background: #0b5ed7;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #084298;
    }

    .output {
      margin-top: 20px;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: #6b7280;
      padding: 20px;
    }

    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<header>
  Capgemini <span>• Mend POM Assistant</span>
</header>

<main>

  <div class="grid">
    <div class="box">
      <h3>POM.xml</h3>
      <textarea id="pomInput"></textarea>
    </div>

    <div class="box">
      <h3>dependency:tree</h3>
      <textarea id="treeInput"></textarea>
    </div>

    <div class="box">
      <h3>Mend report (JSON)</h3>
      <textarea id="mendInput"></textarea>
    </div>
  </div>

  <div class="actions">
    <label>
      <input type="checkbox" id="useExclude">
      Usar <strong>&lt;exclude&gt;</strong> + injetar dependência direta (fallback)
    </label>

    <button onclick="generatePom()">Gerar POM Atualizado</button>
  </div>

  <div class="box output">
    <h3>POM Gerado</h3>
    <textarea id="output" readonly></textarea>
  </div>

</main>

<footer>
  Ferramenta assistiva • Não executa Maven • Não altera código automaticamente
</footer>

<script>
/* =======================
   VERSION COMPARISON
======================= */
function normalizeVersion(v) {
  return v.replace(/[^0-9.]/g, '').split('.').map(n => parseInt(n, 10) || 0);
}

function isVersionGreater(v1, v2) {
  const a = normalizeVersion(v1);
  const b = normalizeVersion(v2);
  const len = Math.max(a.length, b.length);

  for (let i = 0; i < len; i++) {
    const x = a[i] ?? 0;
    const y = b[i] ?? 0;
    if (x > y) return true;
    if (x < y) return false;
  }
  return false;
}

/* =======================
   DEPENDENCY TREE
======================= */
function parseDependencyTree(text) {
  const deps = new Set();
  text.split('\n').forEach(line => {
    const m = line.match(/ ([a-zA-Z0-9_.-]+):([a-zA-Z0-9_.-]+):[^:]+:/);
    if (m) deps.add(`${m[1]}:${m[2]}`);
  });
  return deps;
}

function mapDependencyParents(text) {
  const parents = new Map();
  let stack = [];

  text.split('\n').forEach(line => {
    const depth = (line.match(/\|  /g) || []).length;
    const m = line.match(/ ([a-zA-Z0-9_.-]+):([a-zA-Z0-9_.-]+):[^:]+:/);
    if (!m) return;

    const ga = `${m[1]}:${m[2]}`;
    stack[depth] = ga;
    if (depth > 0) parents.set(ga, stack[depth - 1]);
  });

  return parents;
}

/* =======================
   MEND PARSER
======================= */
function extractFixesFromMend(mend) {
  const fixes = new Map();
  if (!mend.libraries) return fixes;

  const regex = /([a-zA-Z0-9_.-]+):([a-zA-Z0-9_.-]+):([0-9][0-9A-Za-z_.-]*)/g;

  for (const lib of mend.libraries) {
    if (!lib.vulnerabilities) continue;

    for (const vul of lib.vulnerabilities) {
      if (!vul.topFix?.fixResolution) continue;

      let match;
      while ((match = regex.exec(vul.topFix.fixResolution)) !== null) {
        const ga = `${match[1]}:${match[2]}`;
        const version = match[3].split(',')[0];

        if (!fixes.has(ga) || isVersionGreater(version, fixes.get(ga))) {
          fixes.set(ga, version);
        }
      }
    }
  }

  return fixes;
}

/* =======================
   XML BUILDERS
======================= */
function buildDependencyManagement(fixes, treeDeps, existingDM) {
  let xml = [];
  xml.push('<dependencyManagement>');
  xml.push('  <dependencies>');
  if (existingDM) xml.push(existingDM.trim());

  for (const [ga, version] of fixes.entries()) {
    if (!treeDeps.has(ga)) continue;
    if (existingDM?.includes(`<artifactId>${ga.split(':')[1]}</artifactId>`)) continue;

    const [g, a] = ga.split(':');
    xml.push('');
    xml.push('    <dependency>');
    xml.push(`      <groupId>${g}</groupId>`);
    xml.push(`      <artifactId>${a}</artifactId>`);
    xml.push(`      <version>${version}</version>`);
    xml.push('    </dependency>');
  }

  xml.push('');
  xml.push('  </dependencies>');
  xml.push('</dependencyManagement>');
  return xml.join('\n');
}

function buildExcludes(fixes, parents) {
  const xml = [];

  for (const [ga, version] of fixes.entries()) {
    const parent = parents.get(ga);
    if (!parent) continue;

    const [pg, pa] = parent.split(':');
    const [g, a] = ga.split(':');

    xml.push('');
    xml.push('  <!-- Fallback via exclude -->');
    xml.push('  <dependency>');
    xml.push(`    <groupId>${pg}</groupId>`);
    xml.push(`    <artifactId>${pa}</artifactId>`);
    xml.push('    <exclusions>');
    xml.push('      <exclusion>');
    xml.push(`        <groupId>${g}</groupId>`);
    xml.push(`        <artifactId>${a}</artifactId>`);
    xml.push('      </exclusion>');
    xml.push('    </exclusions>');
    xml.push('  </dependency>');

    xml.push('');
    xml.push('  <dependency>');
    xml.push(`    <groupId>${g}</groupId>`);
    xml.push(`    <artifactId>${a}</artifactId>`);
    xml.push(`    <version>${version}</version>`);
    xml.push('  </dependency>');
  }

  return xml.join('\n');
}

/* =======================
   MAIN
======================= */
function generatePom() {
  const pom = pomInput.value;
  const tree = treeInput.value;
  const useExclude = useExclude.checked;

  let mend;
  try {
    mend = JSON.parse(mendInput.value);
  } catch {
    alert('JSON do Mend inválido');
    return;
  }

  const treeDeps = parseDependencyTree(tree);
  const parents = mapDependencyParents(tree);
  const fixes = extractFixesFromMend(mend);

  let existingDM = null;
  let newPom = pom;
  const dmRegex = /<dependencyManagement>([\s\S]*?)<\/dependencyManagement>/;

  if (dmRegex.test(pom)) {
    existingDM = pom.match(dmRegex)[1];
    newPom = pom.replace(dmRegex, '');
  }

  const dmBlock = buildDependencyManagement(fixes, treeDeps, existingDM);
  newPom = newPom.replace('</project>', '\n\n' + dmBlock + '\n');

  if (useExclude) {
    const excludeBlock = buildExcludes(fixes, parents);
    newPom = newPom.replace('</dependencies>', '\n' + excludeBlock + '\n</dependencies>');
  }

  newPom += '\n</project>';
  output.value = newPom;
}
</script>

</body>
</html>
