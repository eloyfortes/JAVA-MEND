<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Capgemini - Maven Dependency Fixer</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 20px;
}

h1 {
  text-align: center;
  color: #003366;
}

.container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

textarea {
  width: 100%;
  height: 220px;
  padding: 10px;
  font-family: monospace;
  font-size: 13px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.full {
  grid-column: span 2;
}

button {
  padding: 12px 25px;
  background: #003366;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

button:hover {
  background: #00509e;
}

label {
  font-weight: bold;
}

#warningsBox {
  display: none;
}

.warning {
  background: #fff3cd;
  border: 1px solid #ffeeba;
}

.output {
  background: #eef2f7;
}
</style>
</head>

<body>

<h1>Capgemini – Maven Dependency Fixer</h1>

<div class="container">

  <div>
    <label>POM.xml</label>
    <textarea id="pomInput"></textarea>
  </div>

  <div>
    <label>dependency:tree</label>
    <textarea id="treeInput"></textarea>
  </div>

  <div class="full">
    <label>Relatório Mend (JSON)</label>
    <textarea id="mendInput"></textarea>
  </div>

  <div class="full">
    <label>
      <input type="checkbox" id="useExclude">
      Gerar alternativa com exclude + dependency direta
    </label>
  </div>

  <div class="full" style="text-align:center;">
    <button onclick="processar()">Gerar POM Atualizado</button>
  </div>

  <div class="full">
    <label>POM Sugerido</label>
    <textarea id="pomOutput" class="output"></textarea>
  </div>

  <div class="full" id="warningsBox">
    <label>⚠️ Dependências limitadas pela versão do Java</label>
    <textarea id="warningsOutput" class="warning" readonly></textarea>
  </div>

</div>

<script>
function getJavaVersion(pom) {
  const m = pom.match(/<java.version>(.*?)<\/java.version>/);
  if (m) return parseInt(m[1]);
  if (pom.includes("maven.compiler.source")) {
    const s = pom.match(/<maven.compiler.source>(.*?)<\/maven.compiler.source>/);
    if (s) return parseInt(s[1]);
  }
  return 8;
}

function maxSpringForJava(java) {
  if (java >= 17) return "6.2.11";
  return "5.3.39";
}

function extractHighestFix(fixResolution, gav) {
  if (!fixResolution) return null;
  const parts = fixResolution.split(";");
  for (let p of parts) {
    if (p.includes(gav)) {
      const versions = p.split(":").pop().split(",").map(v => v.trim());
      return versions.sort((a,b)=>compareVersion(b,a))[0];
    }
  }
  return null;
}

function compareVersion(a,b) {
  return a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'});
}

function processar() {
  const pom = document.getElementById("pomInput").value;
  const mend = JSON.parse(document.getElementById("mendInput").value);
  const javaVersion = getJavaVersion(pom);
  const useExclude = document.getElementById("useExclude").checked;

  const depMap = {};
  const warnings = [];

  mend.forEach(item => {
    const gav = `${item.groupId}:${item.artifactId}`;
    let best = null;

    item.vulnerabilities.forEach(v => {
      const fix = extractHighestFix(v.topFix?.fixResolution, gav);
      if (fix && (!best || compareVersion(fix, best) > 0)) {
        best = fix;
      }
    });

    if (!best) return;

    let applied = best;

    if (gav.startsWith("org.springframework")) {
      const max = maxSpringForJava(javaVersion);
      if (compareVersion(best, max) > 0) {
        warnings.push({
          gav,
          recommended: best,
          applied: max,
          reason: `Spring ${best} requer Java 17+`
        });
        applied = max;
      }
    }

    depMap[gav] = applied;
  });

  let dm = `<dependencyManagement>
  <dependencies>
`;

  Object.entries(depMap).forEach(([gav, ver]) => {
    const [g,a] = gav.split(":");
    dm += `    <dependency>
      <groupId>${g}</groupId>
      <artifactId>${a}</artifactId>
      <version>${ver}</version>
    </dependency>
`;
  });

  dm += `  </dependencies>
</dependencyManagement>`;

  let outputPom = pom.replace("</project>", dm + "\n\n</project>");

  if (useExclude) {
    outputPom += "\n\n<!-- Alternativa com exclude deve ser aplicada manualmente nos starters -->";
  }

  document.getElementById("pomOutput").value = outputPom;

  if (warnings.length) {
    document.getElementById("warningsBox").style.display = "block";
    document.getElementById("warningsOutput").value =
      warnings.map(w =>
`${w.gav}
- Recomendado (Mend): ${w.recommended}
- Aplicado: ${w.applied}
- Motivo: ${w.reason}
`).join("\n");
  } else {
    document.getElementById("warningsBox").style.display = "none";
  }
}
</script>

</body>
</html>
