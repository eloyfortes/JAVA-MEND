<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Capgemini • Mend POM Assistant</title>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(135deg, #f6f7fb, #e9ecf3);
  color: #1f2937;
}
header {
  background: #0b5ed7;
  color: white;
  padding: 20px 30px;
  font-size: 22px;
  font-weight: 600;
}
header span { font-weight: 300; opacity: .9; }
main {
  padding: 25px;
  max-width: 1600px;
  margin: auto;
}
.grid {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 20px;
}
.box {
  background: white;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 8px 25px rgba(0,0,0,.08);
  display: flex;
  flex-direction: column;
}
.box h3 {
  margin: 0 0 10px;
  font-size: 15px;
}
textarea {
  flex: 1;
  resize: vertical;
  min-height: 260px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  padding: 10px;
  font-family: Consolas, monospace;
  font-size: 13px;
}
.actions {
  display: flex;
  justify-content: space-between;
  margin: 20px 0;
}
button {
  background: #0b5ed7;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  cursor: pointer;
}
footer {
  text-align: center;
  font-size: 12px;
  color: #6b7280;
  padding: 20px;
}
@media (max-width:1200px){
  .grid{ grid-template-columns:1fr; }
}
#warningsBox {
  padding: 10px;
  display: none;
}
</style>
</head>

<body>

<header>
  Capgemini <span>• Mend POM Assistant</span>
</header>

<main>

<div class="grid">
  <div class="box">
    <h3>POM.xml</h3>
    <textarea id="pomInput"></textarea>
  </div>
  <div class="box">
    <h3>dependency:tree</h3>
    <textarea id="treeInput"></textarea>
  </div>
  <div class="box">
    <h3>Mend report (JSON)</h3>
    <textarea id="mendInput"></textarea>
  </div>
</div>

<div class="actions">
  <label>
    <input type="checkbox" id="useExclude">
    Usar exclude + dependência direta (fallback)
  </label>
  <button onclick="generatePom()">Gerar POM Atualizado</button>
</div>

<div class="box">
  <h3>POM Gerado</h3>
  <textarea id="output" readonly></textarea>
</div>

<div class="box" id="warningsBox">
  <h3>⚠️ Dependências limitadas pela versão do Java</h3>
  <textarea id="warningsArea" readonly></textarea>
</div>

</main>

<footer>
  Ferramenta assistiva • Versão final corrigida
</footer>

<script>
/* ===== VERSION UTIL ===== */
const norm = v =>
  v.replace(/[^0-9.]/g,'').split('.').map(n => parseInt(n,10) || 0);

const gt = (a,b) => {
  const A = norm(a), B = norm(b);
  for (let i = 0; i < Math.max(A.length,B.length); i++) {
    const x = A[i] || 0, y = B[i] || 0;
    if (x > y) return true;
    if (x < y) return false;
  }
  return false;
};

/* ===== JAVA ===== */
function getJava(pom){
  return +(pom.match(/<java.version>(.*?)<\/java.version>/)?.[1] || 8);
}

/* ===== PARSE DEPENDENCY TREE (REAL) ===== */
function parseTreeParents(text) {
  const lines = text.split('\n').filter(l => l.includes('+-') || l.includes('\\-'));
  const stack = [];
  const parents = new Map(); // child -> Set(parents)

  lines.forEach(line => {
    const depth = (line.match(/\|/g) || []).length;
    const m = line.match(/ ([\w.-]+):([\w.-]+):/);
    if (!m) return;

    const ga = `${m[1]}:${m[2]}`;

    stack[depth] = ga;
    stack.length = depth + 1;

    if (depth > 0) {
      const parent = stack[depth - 1];
      if (!parents.has(ga)) parents.set(ga, new Set());
      parents.get(ga).add(parent);
    }
  });

  return parents;
}

/* ===== MEND ===== */
function extractFixes(m){
  const r=/([\w.-]+):([\w.-]+):([0-9][\w.-]*)/g;
  const f=new Map();

  m.libraries?.forEach(l =>
    l.vulnerabilities?.forEach(v => {
      let x;
      while((x=r.exec(v.topFix?.fixResolution||''))){
        const ga = x[1]+':'+x[2];
        const ver = x[3].split(',')[0];
        if(!f.has(ga) || gt(ver, f.get(ga))){
          f.set(ga, ver);
        }
      }
    })
  );
  return f;
}

/* ===== DM PARSER ===== */
function parseDM(xml){
  const map=new Map();
  const rx=/<dependency>[\s\S]*?<groupId>(.*?)<\/groupId>[\s\S]*?<artifactId>(.*?)<\/artifactId>[\s\S]*?<version>(.*?)<\/version>/g;
  let m;
  while((m=rx.exec(xml))) map.set(m[1]+':'+m[2],m[3]);
  return map;
}

/* ===== MAIN ===== */
function generatePom(){
  let pom = pomInput.value;
  const java = getJava(pom);
  const mend = JSON.parse(mendInput.value);
  const useExclude = document.getElementById("useExclude").checked;

  const fixes = extractFixes(mend);
  const parentsMap = parseTreeParents(treeInput.value);

  const warns = [];
  const excludes = new Map(); // parent -> Set(child)
  const directDeps = new Map();

  let dmMatch = pom.match(/<dependencyManagement>[\s\S]*?<\/dependencyManagement>/);
  let dmMap = dmMatch ? parseDM(dmMatch[0]) : new Map();

  fixes.forEach((ver,ga)=>{
    let applied = ver;

    /* SPRING BLOCK */
    if(ga.startsWith("org.springframework") && java < 17 && gt(ver,"5.3.39")){
      applied = "5.3.39";
      warns.push(`${ga}\n- Recomendado: ${ver}\n- Aplicado: ${applied}\n- Motivo: Spring 6 requer Java 17+`);
    }

    /* LOGBACK BLOCK */
    if(ga.startsWith("ch.qos.logback") && java < 11 && gt(ver,"1.2.13")){
      applied = "1.2.13";
      warns.push(`${ga}\n- Recomendado: ${ver}\n- Aplicado: ${applied}\n- Motivo: Logback >= 1.3 requer Java 11+`);
    }

    dmMap.set(ga, applied);

    if (useExclude) {
      const parents = parentsMap.get(ga);
      if (parents) {
        parents.forEach(p => {
          if (!excludes.has(p)) excludes.set(p,new Set());
          excludes.get(p).add(ga);
        });
      }
      directDeps.set(ga, applied);
    }
  });

  /* ===== BUILD DM ===== */
  let dm = `<dependencyManagement>\n  <dependencies>\n`;
  dmMap.forEach((v,ga)=>{
    const[g,a]=ga.split(':');
    dm+=`    <dependency>
      <groupId>${g}</groupId>
      <artifactId>${a}</artifactId>
      <version>${v}</version>
    </dependency>\n`;
  });
  dm += `  </dependencies>\n</dependencyManagement>`;

  /* ===== BUILD EXCLUDES ===== */
  let excludeXml = '';
  excludes.forEach((children,parent)=>{
    const [pg,pa] = parent.split(':');
    excludeXml += `<dependency>
  <groupId>${pg}</groupId>
  <artifactId>${pa}</artifactId>
  <exclusions>\n`;
    children.forEach(c=>{
      const [cg,ca] = c.split(':');
      excludeXml += `    <exclusion>
      <groupId>${cg}</groupId>
      <artifactId>${ca}</artifactId>
    </exclusion>\n`;
    });
    excludeXml += `  </exclusions>
</dependency>\n\n`;
  });

  /* ===== BUILD DIRECT DEPS ===== */
  let directXml = '';
  directDeps.forEach((v,ga)=>{
    const[g,a]=ga.split(':');
    directXml += `<dependency>
  <groupId>${g}</groupId>
  <artifactId>${a}</artifactId>
  <version>${v}</version>
</dependency>\n\n`;
  });

  pom = pom.replace(/<dependencyManagement>[\s\S]*?<\/dependencyManagement>/,'');
  output.value = pom.replace(
    '</project>',
    `\n${dm}\n${useExclude ? '\n<!-- ===== EXCLUDES ===== -->\n'+excludeXml+'\n<!-- ===== DEPENDÊNCIAS DIRETAS ===== -->\n'+directXml : ''}\n</project>`
  );

  warningsBox.style.display = warns.length ? 'flex' : 'none';
  warningsArea.value = warns.join('\n\n');
}
</script>

</body>
</html>
